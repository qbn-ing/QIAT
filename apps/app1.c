
#include "../lib/std.h"
#include "../include/math.h"
#include "../include/types.h"
#include "../include/display.h"
#define POINTNUM 50
#define CHARNUM 150
#define CELL 100
#define CELLW SCREENW / CELL
#define CELLH SCREENH / CELL
int8_t *welcome_str = "         _______                  _____                    _____            _____          \n        /::\\    \\                /\\    \\                  /\\    \\          /\\    \\         \n       /::::\\    \\              /::\\    \\                /::\\    \\        /::\\    \\        \n      /::::::\\    \\             \\:::\\    \\              /::::\\    \\       \\:::\\    \\       \n     /::::::::\\    \\             \\:::\\    \\            /::::::\\    \\       \\:::\\    \\      \n    /:::/~~\\:::\\    \\             \\:::\\    \\          /:::/\\:::\\    \\       \\:::\\    \\     \n   /:::/    \\:::\\    \\             \\:::\\    \\        /:::/__\\:::\\    \\       \\:::\\    \\    \n  /:::/    / \\:::\\    \\            /::::\\    \\      /::::\\   \\:::\\    \\      /::::\\    \\   \n /:::/____/   \\:::\\____\\  ____    /::::::\\    \\    /::::::\\   \\:::\\    \\    /::::::\\    \\  \n|:::|    |     |:::|    |/\\   \\  /:::/\\:::\\    \\  /:::/\\:::\\   \\:::\\    \\  /:::/\\:::\\    \\ \n|:::|____|     |:::|____/::\\   \\/:::/  \\:::\\____\\/:::/  \\:::\\   \\:::\\____\\/:::/  \\:::\\____\\\n \\:::\\   _\\___/:::/    /\\:::\\  /:::/    \\::/    /\\::/    \\:::\\  /:::/    /:::/    \\::/    /\n  \\:::\\ |::| /:::/    /  \\:::\\/:::/    / \\/____/  \\/____/ \\:::\\/:::/    /:::/    / \\/____/ \n   \\:::\\|::|/:::/    /    \\::::::/    /                    \\::::::/    /:::/    /          \n    \\::::::::::/    /      \\::::/____/                      \\::::/    /:::/    /           \n     \\::::::::/    /        \\:::\\    \\                      /:::/    /\\::/    /            \n      \\::::::/    /          \\:::\\    \\                    /:::/    /  \\/____/             \n       \\::::/____/            \\:::\\    \\                  /:::/    /                       \n        |::|    |              \\:::\\____\\                /:::/    /                        \n        |::|____|               \\::/    /                \\::/    /                         \n         ~~                      \\/____/                  \\/____/                          \n";
int8_t *welcome_str1 = "         _______                  _____                    _____            _____          \n\r        /::\\    \\                /\\    \\                  /\\    \\          /\\    \\         \n\r       /::::\\    \\              /::\\    \\                /::\\    \\        /::\\    \\        \n\r      /::::::\\    \\             \\:::\\    \\              /::::\\    \\       \\:::\\    \\       \n\r     /::::::::\\    \\             \\:::\\    \\            /::::::\\    \\       \\:::\\    \\      \n\r    /:::/~~\\:::\\    \\             \\:::\\    \\          /:::/\\:::\\    \\       \\:::\\    \\     \n\r   /:::/    \\:::\\    \\             \\:::\\    \\        /:::/__\\:::\\    \\       \\:::\\    \\    \n\r  /:::/    / \\:::\\    \\            /::::\\    \\      /::::\\   \\:::\\    \\      /::::\\    \\   \n\r /:::/____/   \\:::\\____\\  ____    /::::::\\    \\    /::::::\\   \\:::\\    \\    /::::::\\    \\  \n\r|:::|    |     |:::|    |/\\   \\  /:::/\\:::\\    \\  /:::/\\:::\\   \\:::\\    \\  /:::/\\:::\\    \\ \n\r|:::|____|     |:::|____/::\\   \\/:::/  \\:::\\____\\/:::/  \\:::\\   \\:::\\____\\/:::/  \\:::\\____\\\n\r \\:::\\   _\\___/:::/    /\\:::\\  /:::/    \\::/    /\\::/    \\:::\\  /:::/    /:::/    \\::/    /\n\r  \\:::\\ |::| /:::/    /  \\:::\\/:::/    / \\/____/  \\/____/ \\:::\\/:::/    /:::/    / \\/____/ \n\r   \\:::\\|::|/:::/    /    \\::::::/    /                    \\::::::/    /:::/    /          \n\r    \\::::::::::/    /      \\::::/____/                      \\::::/    /:::/    /           \n\r     \\::::::::/    /        \\:::\\    \\                      /:::/    /\\::/    /            \n\r      \\::::::/    /          \\:::\\    \\                    /:::/    /  \\/____/             \n\r       \\::::/____/            \\:::\\    \\                  /:::/    /                       \n\r        |::|    |              \\:::\\____\\                /:::/    /                        \n\r        |::|____|               \\::/    /                \\::/    /                         \n\r         ~~                      \\/____/                  \\/____/                          \n\r";
typedef struct charpoint
{
    int8_t *buf; // 字符串
    int32_t x;   // 出生点
    int32_t y;
} charpoint;
int32_t num = 0;

charpoint cp[150];
uint32_t *fb;
int32_t *life, *nextlife;
int32_t ps[8][2] = {{1, 1}, {1, -1}, {1, 0}, {-1, 0}, {-1, -1}, {-1, 1}, {0, 1}, {0, -1}};
void init()
{
    sprint("start init!\n\r");
    set_seed(get_ticks() + 1024);
    fb = get_buffer();
    for (int32_t i = 0; i < CHARNUM; i++)
    {
        cp[i].buf = (int8_t *)umalloc(SCREENH / 16);
        do
        {
            cp[i].x = rand(SCREENW - 8);
        } while (cp[i].x + 8 >= SCREENW);
        do
        {
            cp[i].y = rand(SCREENH - 16);
        } while (cp[i].y + 16 >= SCREENH);
    }
}
int8_t rand_chara()
{
    return rand(95) + 32;
}
void cal_next()
{
    sprint("num==");
    dprint(num);
    clear_screen();
    for (int i = 0; i < POINTNUM; i++)
    {
        cp[i].buf[num] = rand_chara();
    }
    num++;
    for (int i = 0; i < POINTNUM; i++)
    {
        for (int j = num - 1; j >= 0; j--)
        {
            if (cp[i].y + (num - j - 1) * 16 <= SCREENH - 16)
                color_printc1(cp[i].buf[j], cp[i].x, cp[i].y + (num - j - 1) * 16, 0, 255, 0, 0, 0, 0);
        }
    }
    sprint("nextok\n\r");
}
// 45*45算一个小格
void set_cell(int32_t x, int32_t y, int32_t val)
{
    nextlife[x + y * CELLW] = val;
}
void switch_cell()
{
    memcpy(life, nextlife, sizeof(int32_t) * CELLW * CELLH);
}
void check(int32_t x, int32_t y)
{
    int32_t num = 0;
    for (int32_t i = 0; i < 8; i++)
    {
        int32_t tx = x + ps[i][0], ty = y + ps[i][1];
        if (tx >= 0 && tx < CELLW && ty >= 0 && ty < CELLH)
        {
            num += life[ty * CELLW + tx];
        }
    }
    if (num < 2 || num > 3)
    {
        set_cell(x, y, 0);
    }
    else if (num == 3)
    {
        // nextlife[x + y * CELLW] = 1;
        set_cell(x, y, 1);
    }
    else
    {
        // nextlife[x + y * CELLW] = life[x + y * CELLW];
        set_cell(x, y, life[x + y * CELLW]);
    }
}
void draw_cell()
{
    for (int32_t i = 0; i < CELLH; i++)
    {
        for (int32_t j = 0; j < CELLW; j++)
        {
            if (life[i * CELLW + j] != 1)
            {
                draw_rect(j * CELL, i * CELL, (j + 1) * CELL, (i + 1) * CELL, 0xfd, 0xfd, 0xfd, 255);
            }
            else
            {
                draw_rect(j * CELL, i * CELL, (j + 1) * CELL, (i + 1) * CELL, 0, 0, 0, 255);
            }
        }
    }
}
void run_cell()
{
    for (int32_t i = 0; i < CELLH; i++)
    {
        for (int32_t j = 0; j < CELLW; j++)
        {
            check(j, i);
        }
    }
    switch_cell();
    draw_cell();
}

void lifegame_init()
{
    life = (int32_t *)umalloc(sizeof(int32_t) * CELLW * CELLH);
    memset(life, 0, sizeof(int32_t) * CELLW * CELLH);
    nextlife = (int32_t *)umalloc(sizeof(int32_t) * CELLW * CELLH);
    memset(nextlife, 0, sizeof(int32_t) * CELLW * CELLH);
    // set_cell(1, 2, 1);
    // set_cell(2, 2, 1);
    // set_cell(2, 4, 1);
    // set_cell(3, 1, 1);
    // set_cell(3, 3, 1);
    // set_cell(4, 3, 1);
    //******

    //******
    set_cell(3, 1, 1);
    set_cell(3, 2, 1);
    set_cell(5, 2, 1);
    set_cell(1, 3, 1);
    set_cell(2, 4, 1);
    set_cell(4, 4, 1);
    set_cell(5, 4, 1);
    set_cell(6, 4, 1);
    set_cell(1, 5, 1);
    set_cell(3, 6, 1);
    set_cell(5, 6, 1);
    set_cell(3, 7, 1);
    // set_cell(3, 4, 1);
    // switch_cell();
}
void rand_cell()
{
    int32_t nt = rand(CELLH * CELLW - 1);
    while (nt <= 8 || nt > CELLH * CELLW)
        nt = rand(CELLH * CELLW - 1);
    for (int32_t i = 0; i < nt; i++)
    {
        int32_t x = rand(CELLW), y = rand(CELLH);
        set_cell(x, y, 1);
    }
    switch_cell();
}
int main()
{
    sprint(welcome_str1);
    init();
    sprint("init!!ok\n");
    while (num < 50)
    {
        cal_next();
        display(fb);
        sleep(100);
    }
    clear_screen();
    int32_t xz = 0;
    int8_t cha;
    prints1("Please press space to continue!", 400, 600, xz ^ 1);
    while (1)
    {
        cha = getchar();
        if (cha == ' ')
        {
            break;
        }
        prints1(welcome_str, 300, 100, xz);
        prints1("Qiat Is A Toy.", 400, 500, xz ^ 1);
        xz ^= 1;
        display(fb);
        sleep(500);
    }
    clear_screen1();
    lifegame_init();
    set_cell(3, 4, 1);
    switch_cell();
    draw_cell();
    display(fb);
    while (1)
    {
        run_cell();
        display(fb);
        cha = getchar();
        if (cha == ' ')
        {
            rand_cell();
        }

        sleep(500);
    }
}

// #include "include/display.h"
// #include "include/math.h"
// #include "lib/std.h"
// #define SPEED 25
// int8_t *ss = "         _______                  _____                    _____            _____          \n        /::\\    \\                /\\    \\                  /\\    \\          /\\    \\         \n       /::::\\    \\              /::\\    \\                /::\\    \\        /::\\    \\        \n      /::::::\\    \\             \\:::\\    \\              /::::\\    \\       \\:::\\    \\       \n     /::::::::\\    \\             \\:::\\    \\            /::::::\\    \\       \\:::\\    \\      \n    /:::/~~\\:::\\    \\             \\:::\\    \\          /:::/\\:::\\    \\       \\:::\\    \\     \n   /:::/    \\:::\\    \\             \\:::\\    \\        /:::/__\\:::\\    \\       \\:::\\    \\    \n  /:::/    / \\:::\\    \\            /::::\\    \\      /::::\\   \\:::\\    \\      /::::\\    \\   \n /:::/____/   \\:::\\____\\  ____    /::::::\\    \\    /::::::\\   \\:::\\    \\    /::::::\\    \\  \n|:::|    |     |:::|    |/\\   \\  /:::/\\:::\\    \\  /:::/\\:::\\   \\:::\\    \\  /:::/\\:::\\    \\ \n|:::|____|     |:::|____/::\\   \\/:::/  \\:::\\____\\/:::/  \\:::\\   \\:::\\____\\/:::/  \\:::\\____\\\n \\:::\\   _\\___/:::/    /\\:::\\  /:::/    \\::/    /\\::/    \\:::\\  /:::/    /:::/    \\::/    /\n  \\:::\\ |::| /:::/    /  \\:::\\/:::/    / \\/____/  \\/____/ \\:::\\/:::/    /:::/    / \\/____/ \n   \\:::\\|::|/:::/    /    \\::::::/    /                    \\::::::/    /:::/    /          \n    \\::::::::::/    /      \\::::/____/                      \\::::/    /:::/    /           \n     \\::::::::/    /        \\:::\\    \\                      /:::/    /\\::/    /            \n      \\::::::/    /          \\:::\\    \\                    /:::/    /  \\/____/             \n       \\::::/____/            \\:::\\    \\                  /:::/    /                       \n        |::|    |              \\:::\\____\\                /:::/    /                        \n        |::|____|               \\::/    /                \\::/    /                         \n         ~~                      \\/____/                  \\/____/                          \n";
/***
 *             _______                  _____                    _____            _____
 *            /::\    \                /\    \                  /\    \          /\    \
 *           /::::\    \              /::\    \                /::\    \        /::\    \
 *          /::::::\    \             \:::\    \              /::::\    \       \:::\    \
 *         /::::::::\    \             \:::\    \            /::::::\    \       \:::\    \
 *        /:::/~~\:::\    \             \:::\    \          /:::/\:::\    \       \:::\    \
 *       /:::/    \:::\    \             \:::\    \        /:::/__\:::\    \       \:::\    \
 *      /:::/    / \:::\    \            /::::\    \      /::::\   \:::\    \      /::::\    \
 *     /:::/____/   \:::\____\  ____    /::::::\    \    /::::::\   \:::\    \    /::::::\    \
 *    |:::|    |     |:::|    |/\   \  /:::/\:::\    \  /:::/\:::\   \:::\    \  /:::/\:::\    \
 *    |:::|____|     |:::|____/::\   \/:::/  \:::\____\/:::/  \:::\   \:::\____\/:::/  \:::\____\
 *     \:::\   _\___/:::/    /\:::\  /:::/    \::/    /\::/    \:::\  /:::/    /:::/    \::/    /
 *      \:::\ |::| /:::/    /  \:::\/:::/    / \/____/  \/____/ \:::\/:::/    /:::/    / \/____/
 *       \:::\|::|/:::/    /    \::::::/    /                    \::::::/    /:::/    /
 *        \::::::::::/    /      \::::/____/                      \::::/    /:::/    /
 *         \::::::::/    /        \:::\    \                      /:::/    /\::/    /
 *          \::::::/    /          \:::\    \                    /:::/    /  \/____/
 *           \::::/____/            \:::\    \                  /:::/    /
 *            |::|    |              \:::\____\                /:::/    /
 *            |::|____|               \::/    /                \::/    /
 *             ~~                      \/____/                  \/____/
 *
 */
